syntax = "proto3";

package flowcraft.v1.core;

import "google/protobuf/struct.proto";
import "flowcraft/v1/core/base.proto";
import "flowcraft/v1/core/kernel.proto";
import "flowcraft/v1/nodes/chat_node.proto";
import "flowcraft/v1/nodes/ai_gen_node.proto";
import "flowcraft/v1/nodes/media_node.proto";

message Node {
  // 1-15: Identity & Core Structural
  string node_id = 1;           
  string template_id = 2;       
  NodeKind node_kind = 3;       

  // 16-30: Layered Data
  Presentation presentation = 16; 
  NodeData state = 17;           
  VisualHint visual_hint = 18;   
}

message NodeTemplate {
  string template_id = 1;
  string display_name = 2;
  repeated string menu_path = 3;
  NodeData default_state = 4;
  int32 default_width = 5;
  int32 default_height = 6;
  google.protobuf.Struct widgets_schema = 7; // JSON Schema for all widgets in this node
}

message NodeData {
  // 1-15: Core Metadata
  string display_name = 1;      
  RenderMode active_mode = 2;
  string task_id = 3;
  int32 schema_version = 4;     // Versioning for future migrations

  // 16-50: UI & Common Components
  repeated RenderMode available_modes = 16;
  MediaContent media = 17;
  repeated Widget widgets = 18;
  repeated Port input_ports = 19;
  repeated Port output_ports = 20;

  // 51-100: Business Extensions (Strongly typed)
  oneof extension {
    flowcraft.v1.nodes.ChatNodeState chat = 51;
    flowcraft.v1.nodes.AiGenNodeState ai_gen = 52;
    flowcraft.v1.nodes.VisualNodeState visual = 53;
    flowcraft.v1.nodes.DocumentNodeState document = 54;
    flowcraft.v1.nodes.AcousticNodeState acoustic = 55;
  }

  // 100+: Opaque/Legacy Data
  map<string, string> metadata = 100;
  google.protobuf.Struct widgets_values = 101; 
  google.protobuf.Struct widgets_schema = 102; 
}

enum RenderMode {
  MODE_UNSPECIFIED = 0;
  MODE_MEDIA = 1;
  MODE_WIDGETS = 2;
  MODE_MARKDOWN = 3;
  MODE_CHAT = 4;
}

message Port {
  string id = 1;
  string label = 2;
  PortType type = 3;
  string color = 4;
  PortStyle style = 5;
  string description = 6;
}

message PortType {
  flowcraft.v1.core.PortMainType main_type = 1;
  string item_type = 2;
  bool is_generic = 3;
}

enum PortStyle {
  CIRCLE = 0;
  SQUARE = 1;
  DIAMOND = 2;
  DASH = 3;
}

message Widget {
  string id = 1;
  WidgetType type = 2;
  string label = 3;
  google.protobuf.Value value = 4; 
  WidgetConfig config = 5;
  repeated WidgetOption options = 6;
  bool is_readonly = 7;
  bool is_loading = 8;
  string input_port_id = 9; 
}

enum WidgetType {
  WIDGET_UNSPECIFIED = 0;
  WIDGET_TEXT = 1;
  WIDGET_SELECT = 2;
  WIDGET_CHECKBOX = 3;
  WIDGET_SLIDER = 4;
  WIDGET_BUTTON = 5;
}

message WidgetOption {
  string label = 1;
  string value = 2;
  string description = 3;
}

message WidgetConfig {
  string placeholder = 1;
  double min = 2;
  double max = 3;
  double step = 4;
  bool dynamic_options = 5;
  string action_target = 6;
}

message Edge {
  string edge_id = 1;
  string source_node_id = 2;
  string target_node_id = 3;
  string source_handle = 4;
  string target_handle = 5;
  map<string, string> metadata = 6;
}


