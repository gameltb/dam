syntax = "proto3";

package flowcraft.v1.services;

import "google/protobuf/struct.proto";
import "flowcraft/v1/core/base.proto";
import "flowcraft/v1/core/node.proto";
import "flowcraft/v1/core/kernel.proto";
import "flowcraft/v1/core/signals.proto";
import "flowcraft/v1/core/action.proto";

message FlowMessage {
  string message_id = 1;
  int64 timestamp = 2;

  oneof payload {
    SyncRequest sync_request = 10;
    flowcraft.v1.core.ActionExecutionRequest action_execute = 14;
    flowcraft.v1.core.ActionDiscoveryRequest action_discovery = 17;
    TaskCancelRequest task_cancel = 15;
    ViewportUpdate viewport_update = 16;
    flowcraft.v1.core.WidgetSignal widget_signal = 18;
    flowcraft.v1.core.NodeSignal node_signal = 27;
    TemplateDiscoveryRequest template_discovery = 19;
    InferenceConfigDiscoveryRequest inference_discovery = 28;

    GraphSnapshot snapshot = 20;
    MutationList mutations = 21;
    flowcraft.v1.core.ActionDiscoveryResponse actions = 25;
    TemplateDiscoveryResponse templates = 26;
    InferenceConfigDiscoveryResponse inference_config = 29;
    flowcraft.v1.core.TaskUpdate task_update = 22;
    ClearChatHistoryRequest chat_clear = 30;
    ResetNodeRequest reset_node = 31;
    NodeEvent node_event = 23;
    ErrorResponse error = 24;
  }
}

message ResetNodeRequest {
  string node_id = 1;
  bool clear_data = 2; // Optional: whether to also clear node state/widgets
}


message NodeEvent {
  string node_id = 1;
  oneof payload {
    ChatStreamEvent chat_stream = 10;
    LogEvent log = 11;
    NodeProgress progress = 12;
    WidgetStreamEvent widget_stream = 13;
    bytes data = 14;
  }
}

message WidgetStreamEvent {
  string widget_id = 1;
  string chunk_data = 2;
  bool is_done = 3;
}

message ChatStreamEvent {
  string chunk_data = 1;
  bool is_done = 2;
  string message_id = 3;
}

message LogEvent {
  string message = 1;
  LogLevel level = 2;
}

enum LogLevel {
  INFO = 0;
  WARN = 1;
  ERROR = 2;
  DEBUG = 3;
}

message NodeProgress {
  float percentage = 1;
  string status_text = 2;
}

message SyncRequest { 
  string graph_id = 1;
  oneof filter {
    flowcraft.v1.core.Rect target_area = 2;
    NodeIdList node_ids = 3;
    HierarchyFilter hierarchy = 4;
  }
  bool subscribe_to_updates = 5;
}

message NodeIdList {
  repeated string ids = 1;
}

message HierarchyFilter {
  string root_node_id = 1;
  int32 depth = 2;
}

message TemplateDiscoveryRequest {}
message TemplateDiscoveryResponse {
  repeated flowcraft.v1.core.NodeTemplate templates = 1;
}

message ViewportUpdate {
  flowcraft.v1.core.Viewport viewport = 1;
  flowcraft.v1.core.Rect visible_bounds = 2;
}

message MutationList {
  repeated GraphMutation mutations = 1;
  int64 sequence_number = 2;
  flowcraft.v1.core.MutationSource source = 3;
}

message GetHistoryRequest {
  string graph_id = 1;
  int64 from_seq = 2;
  int64 to_seq = 3;
}

message HistoryResponse {
  repeated MutationLogEntry entries = 1;
}

message MutationLogEntry {
  int64 seq = 1;
  GraphMutation mutation = 2;
  int64 timestamp = 3;
  flowcraft.v1.core.MutationSource source = 4;
  string description = 5;
  string user_id = 6;
}

message RollbackRequest {
  string graph_id = 1;
  int64 target_seq = 2;
}

import "flowcraft/v1/actions/chat_actions.proto";

message GetChatHistoryRequest {
  string head_id = 1;
}

message ChatHistoryResponse {
  repeated ChatMessage entries = 1;
}

message ChatMessage {
  string id = 1;
  string role = 2;
  repeated flowcraft.v1.actions.ChatMessagePart parts = 3;
  oneof metadata {
    google.protobuf.Struct metadata_struct = 4;
    ChatMsgMetadata chat_metadata = 5;
  }
  int64 timestamp = 6;
  string parent_id = 7;
  repeated string sibling_ids = 8;
  string tree_id = 9;
}

message ClearChatHistoryRequest {
  string node_id = 1;
}

message ChatMsgMetadata {
  string model_id = 1;
  repeated string attachment_urls = 2;
}

message ErrorResponse {
  string code = 1;
  string message = 2;
}

message GraphSnapshot {
  repeated flowcraft.v1.core.Node nodes = 1;
  repeated flowcraft.v1.core.Edge edges = 2;
  int64 version = 3;
}

message GraphMutation {
  oneof operation {
    AddNodeRequest add_node = 1;
    RemoveNodeRequest remove_node = 3;
    AddEdgeRequest add_edge = 4;
    RemoveEdgeRequest remove_edge = 5;
    ClearGraphRequest clear_graph = 6;
    PathUpdateRequest path_update = 7;
    AddSubGraphRequest add_sub_graph = 8;
    ReparentNodeRequest reparent_node = 9;
  }
}

message ReparentNodeRequest {
  flowcraft.v1.core.MutationMetadata metadata = 1;
  string node_id = 2;
  string new_parent_id = 3;
  flowcraft.v1.core.Position new_position = 4;
}

message AddNodeRequest { 
  flowcraft.v1.core.MutationMetadata metadata = 1;
  flowcraft.v1.core.Node node = 2; 
}

message RemoveNodeRequest { 
  flowcraft.v1.core.MutationMetadata metadata = 1;
  string id = 2; 
}

message AddEdgeRequest { 
  flowcraft.v1.core.MutationMetadata metadata = 1;
  flowcraft.v1.core.Edge edge = 2; 
}

message RemoveEdgeRequest { 
  flowcraft.v1.core.MutationMetadata metadata = 1;
  string id = 2; 
}

message AddSubGraphRequest { 
  flowcraft.v1.core.MutationMetadata metadata = 1;
  repeated flowcraft.v1.core.Node nodes = 2; 
  repeated flowcraft.v1.core.Edge edges = 3; 
}

message ClearGraphRequest {
  flowcraft.v1.core.MutationMetadata metadata = 1;
}

message PathUpdateRequest {
  flowcraft.v1.core.MutationMetadata metadata = 1;
  string target_id = 2;
  string path = 3;
  google.protobuf.Value value = 4;
  enum UpdateType {
    REPLACE = 0;
    MERGE = 1;
    DELETE = 2;
  }
  UpdateType type = 5;
}

message TaskCancelRequest { string task_id = 1; }

message InferenceConfigDiscoveryRequest {}

message InferenceConfigDiscoveryResponse {
  repeated InferenceEndpointSummary endpoints = 1;
  string default_endpoint_id = 2;
  string default_model = 3;
}

message InferenceEndpointSummary {
  string id = 1;
  string name = 2;
  repeated string models = 3;
}

service FlowService {
  rpc WatchGraph(SyncRequest) returns (stream FlowMessage);
  rpc ApplyMutations(MutationList) returns (ErrorResponse);
  rpc SendWidgetSignal(flowcraft.v1.core.WidgetSignal) returns (ErrorResponse);
  rpc SendNodeSignal(flowcraft.v1.core.NodeSignal) returns (ErrorResponse);
  rpc ExecuteAction(flowcraft.v1.core.ActionExecutionRequest) returns (ErrorResponse);
  rpc DiscoverActions(flowcraft.v1.core.ActionDiscoveryRequest) returns (flowcraft.v1.core.ActionDiscoveryResponse);
  rpc DiscoverTemplates(TemplateDiscoveryRequest) returns (TemplateDiscoveryResponse);
  rpc DiscoverInferenceConfig(InferenceConfigDiscoveryRequest) returns (InferenceConfigDiscoveryResponse);
  rpc CancelTask(TaskCancelRequest) returns (ErrorResponse);
  rpc UpdateViewport(ViewportUpdate) returns (ErrorResponse);
  rpc GetHistory(GetHistoryRequest) returns (HistoryResponse);
  rpc Rollback(RollbackRequest) returns (ErrorResponse);
  rpc GetChatHistory(GetChatHistoryRequest) returns (ChatHistoryResponse);
  rpc ClearChatHistory(ClearChatHistoryRequest) returns (ErrorResponse);
}