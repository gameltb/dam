syntax = "proto3";

package flowcraft_proto.v1;

import "base.proto";
import "core/node.proto";
import "core/signals.proto";
import "action.proto";

message FlowMessage {
  string message_id = 1;
  int64 timestamp = 2;

  oneof payload {
    // --- Synchronization ---
    SyncRequest sync_request = 10;
    bytes yjs_update = 11;

    // --- Actions ---
    UpdateNodeRequest node_update = 12;
    UpdateWidgetRequest widget_update = 13;
    ActionExecutionRequest action_execute = 14;
    ActionDiscoveryRequest action_discovery = 17;
    TaskCancelRequest task_cancel = 15;
    ViewportUpdate viewport_update = 16;
    WidgetSignal widget_signal = 18;

    // --- Server -> Client ---
    GraphSnapshot snapshot = 20;
    MutationList mutations = 21;
    ActionDiscoveryResponse actions = 25;
    TaskUpdate task_update = 22;
    StreamChunk stream_chunk = 23;
    ErrorResponse error = 24;
  }
}

message SyncRequest { string graph_id = 1; }

message UpdateNodeRequest {
  string node_id = 1;
  NodeData data = 2;
  Position position = 3;
}

message UpdateWidgetRequest {
  string node_id = 1;
  string widget_id = 2;
  string value_json = 3;
}

message ViewportUpdate {
  Viewport viewport = 1;
  Rect visible_bounds = 2;
}

message MutationList {
  repeated GraphMutation mutations = 1;
  int64 sequence_number = 2;
}

message StreamChunk {
  string node_id = 1;
  string widget_id = 2;
  string chunk_data = 3;
  bool is_done = 4;
}

message ErrorResponse {
  string code = 1;
  string message = 2;
}

message GraphSnapshot {
  repeated Node nodes = 1;
  repeated Edge edges = 2;
  int64 version = 3;
}

message GraphMutation {
  oneof operation {
    AddNode add_node = 1;
    UpdateNode update_node = 2;
    RemoveNode remove_node = 3;
    AddEdge add_edge = 4;
    RemoveEdge remove_edge = 5;
    AddSubGraph add_subgraph = 6;
    ClearGraph clear_graph = 7;
  }
}

message AddNode { Node node = 1; }
message UpdateNode { string id = 1; NodeData data = 2; Position position = 3; string parent_id = 4; }
message RemoveNode { string id = 1; }
message AddEdge { Edge edge = 1; }
message RemoveEdge { string id = 1; }
message AddSubGraph { repeated Node nodes = 1; repeated Edge edges = 2; }
message ClearGraph {}

message TaskUpdate {
  string task_id = 1;
  TaskStatus status = 2;
  double progress = 3;
  string message = 4;
  string result_json = 5;
}

enum TaskStatus {
  TASK_PENDING = 0;
  TASK_PROCESSING = 1;
  TASK_COMPLETED = 2;
  TASK_FAILED = 3;
  TASK_CANCELLED = 4;
}

message TaskCancelRequest { string task_id = 1; }

message Edge {
  string id = 1;
  string source = 2;
  string target = 3;
  string source_handle = 4;
  string target_handle = 5;
  map<string, string> metadata = 6;
}
